
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://sipi.io/lua/lua-image/">
      
      
        <link rel="prev" href="../">
      
      
        <link rel="next" href="../sqlite/">
      
      
      <link rel="icon" href="../../assets/images/dasch-favicon.ico">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.17">
    
    
      
        <title>Lua Image Functions - SIPI Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.bcfcd587.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/style/theme.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-blue" data-md-color-accent="deep-blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#lua-image-functions" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="SIPI Documentation" class="md-header__button md-logo" aria-label="SIPI Documentation" data-md-component="logo">
      
  <img src="../../assets/images/dasch-icon-white.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            SIPI Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Lua Image Functions
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/dasch-swiss/sipi" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    dasch-swiss/sipi
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="SIPI Documentation" class="md-nav__button md-logo" aria-label="SIPI Documentation" data-md-component="logo">
      
  <img src="../../assets/images/dasch-icon-white.svg" alt="logo">

    </a>
    SIPI Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/dasch-swiss/sipi" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    dasch-swiss/sipi
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/introduction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/sipi/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Reference
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/running/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Running
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lua Integration
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Lua Image Functions
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Lua Image Functions
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#sipiimagenewfilename" class="md-nav__link">
    <span class="md-ellipsis">
      SipiImage.new(filename)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sipiimagedims" class="md-nav__link">
    <span class="md-ellipsis">
      SipiImage.dims()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sipiimageexifexif-parameter-name" class="md-nav__link">
    <span class="md-ellipsis">
      SipiImage.exif(&lt;EXIF-parameter-name&gt;)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sipiimagecropiiif-region-string" class="md-nav__link">
    <span class="md-ellipsis">
      SipiImage.crop(&lt;iiif-region-string&gt;)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sipiimagescaleiiif-size-string" class="md-nav__link">
    <span class="md-ellipsis">
      SipiImage.scale(&lt;iiif-size-string&gt;)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sipiimagerotateiiif-rotation-string" class="md-nav__link">
    <span class="md-ellipsis">
      SipiImage.rotate(&lt;iiif-rotation-string&gt;)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sipiimagetopleft" class="md-nav__link">
    <span class="md-ellipsis">
      SipiImage.topleft()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sipiimagewatermarkwm-file-path" class="md-nav__link">
    <span class="md-ellipsis">
      SipiImage.watermark(wm-file-path)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sipiimagewritefilepath-compression_params" class="md-nav__link">
    <span class="md-ellipsis">
      SipiImage.write(filepath, [compression_params])
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sipiimagesendformat" class="md-nav__link">
    <span class="md-ellipsis">
      SipiImage.send(format)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sipiimagemimetype_consistencymimetype-filename" class="md-nav__link">
    <span class="md-ellipsis">
      SipiImage.mimetype_consistency(mimetype, filename)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-image-processing-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      Example: Image Processing Pipeline
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../sqlite/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SQLite Integration
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/building/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Building
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/developing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Developing
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../release-notes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Release Notes
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="lua-image-functions">Lua image functions<a class="headerlink" href="#lua-image-functions" title="Permanent link">&para;</a></h1>
<p>Through Lua scripting, SIPI allows a wide area of utilities to analyze, manipulate and convert images to/from
different formats. This functionality allows to use SIPI e.g. for offering image upload and converting these images
into IIIF conformant long-term storage formats (e.g. JPEG2000). It allows to programmatically modify an image
before delivering it to the client, or to extract data from the images.</p>
<p>The basic concept is a specialized Lua image object that offers all methods to manipulate images.</p>
<h3 id="sipiimagenewfilename">SipiImage.new(filename)<a class="headerlink" href="#sipiimagenewfilename" title="Permanent link">&para;</a></h3>
<p>This method creates a new image object by reading an image file that has to be located somewhere on the SIPI server.</p>
<p>The simple forms are:</p>
<div class="highlight"><pre><span></span><code>img = SipiImage.new(&quot;filepath&quot;)
img = SipiImage.new(index)
</code></pre></div>
<p>The first variant opens a file given by "filepath", the second variant
opens an uploaded file directly using the integer index to the uploaded
files.</p>
<p>If the index of an uploaded file is passed as an argument, this method
adds additional metadata to the <code>SipiImage</code> object that is constructed:
the file's original name, its MIME type, and its SHA256 checksum. When
the <code>SipiImage</code> object is then written to another file, this metadata
will be stored in an extra header record.</p>
<p>If a filename is passed, the method does not add this metadata.</p>
<p>The more complex form is as follows:</p>
<div class="highlight"><pre><span></span><code>img = SipiImage.new(&quot;filename&quot;, {
        region=&lt;iiif-region-string&gt;,
        size=&lt;iiif-size-string&gt;,
        reduce=&lt;integer&gt;,
        original=origfilename,
        hash=&quot;md5&quot;|&quot;sha1&quot;|&quot;sha256&quot;|&quot;sha384&quot;|&quot;sha512&quot;
      })
</code></pre></div>
<p>This creates a new Lua image object and loads the given image into. The
second form allows to indicate a region, the size or a reduce factor and
the original filename. The <code>hash</code> parameter indicates that the given
checksum should be calculated out of the pixel values and written into
the header. All parameters are optional, but at least one has to given.
The meaning of the parameters are:</p>
<ul>
<li><code>region</code>: A region in IIIF format the image should be cropped to.</li>
<li><code>size</code>: The size of the resulting image as valid IIIF size string.</li>
<li><code>reduce</code>: An much faster alternative to size, if the image size will be
  reduced by a integer factor (2=half size, 3=one third size etc.)</li>
<li><code>original</code>: The original file name that should be recorded in the metadata</li>
<li><code>hash</code>: The Hash algorithm that will be used for the hash of the pixel values. Valid
  entries are <code>md5</code>, <code>sha1</code>, <code>sha256</code>, <code>sha384</code> and <code>sha512</code>.</li>
</ul>
<p>For example to read an image and include the SIPI preservation metadata,
the function is called as follows:</p>
<div class="highlight"><pre><span></span><code>SipiImage.new(&quot;path_to_file&quot;, { original=&quot;my_image.tif&quot;, hash=&quot;md5&quot; }
</code></pre></div>
<p>This call will include the preservation metadata (please note that in this case
the original filename is mandatory, since Lua has know direct knowledge about the
original filename. The filepath given as first parameter must not and normally
does not correspond to the original filename). The <code>hash</code>-parameter indicates to
use the md5-algorithm for the has of the pixel values.</p>
<h3 id="sipiimagedims">SipiImage.dims()<a class="headerlink" href="#sipiimagedims" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>  success, dims = img.dims()
  if success then
      server.print(&#39;nx=&#39;, dims.nx, &#39; ny=&#39;, dims.ny, &#39; ori=&#39;, dims.orientation)
  end
</code></pre></div>
<p>This method returns basic information about the image. It returns a Lua table withg the following items:
- <em>nx</em>: Number of pixels in X direction (image width)
- <em>ny</em>: Number of pixels in Y direction (image height)
- <em>orientation</em>: Orientation of image which is an integer with the following meaning:
  - <em>1</em>: (TOPLEFT) The 0th row represents the visual top of the image, and the 0th column represents the visual left-hand side.
  - <em>2</em>: (TOPRIGHT) The 0th row represents the visual top of the image, and the 0th column represents the visual right-hand side.
  - <em>3</em>: (BOTRIGHT) The 0th row represents the visual bottom of the image, and the 0th column represents the visual right-hand side.
  - <em>4</em>: (BOTLEFT) The 0th row represents the visual bottom of the image, and the 0th column represents the visual left-hand side.
  - <em>5</em>: (LEFTTOP) The 0th row represents the visual left-hand side of the image, and the 0th column represents the visual top.
  - <em>6</em>: (RIGHTTOP) The 0th row represents the visual right-hand side of the image, and the 0th column represents the visual top.
  - <em>7</em>: (RIGHTBOT) The 0th row represents the visual right-hand side of the image, and the 0th column represents the visual bottom.
  - <em>8</em>: (LEFTBOT) The 0th row represents the visual left-hand side of the image, and the 0th column represents the visual bottom.</p>
<h3 id="sipiimageexifexif-parameter-name">SipiImage.exif(&lt;EXIF-parameter-name&gt;)<a class="headerlink" href="#sipiimageexifexif-parameter-name" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>success, value-or-errormsg = img:exit(&lt;EXIF-parameter-name&gt;)
</code></pre></div>
<p>Return the value of an exif parameter. The following EXIF parameters are supported:
- <em>"Orientation"</em>: Orientation (integer)
- <em>"Compression"</em>: Compression method (integer)
- <em>"PhotometricInterpretation"</em>: The photometric interpretation (integer)
- <em>"SamplesPerPixel"</em>: Samples per pixel (integer)
- <em>"ResolutionUnit"</em>: 1=none, 2=inches, 3=cm (integer)
- <em>"PlanarConfiguration"</em>: Planar configuration, 1=chunky, 2=planar (integer)
- <em>"DocumentName"</em>: Document name (string)
- <em>"Make"</em>: Make of camera or scanner (string)
- <em>"Model"</em>: Model of camera or scanner (string)
- <em>"Software"</em>: Software used for capture (string)
- <em>"Artist"</em>: Artist that created the image (string)
- <em>"DateTime"</em>: Date and time of creation (string)
- <em>"ImageDescription"</em>: Image description
- <em>"Copyright"</em>: Copyright info
- </p>
<h3 id="sipiimagecropiiif-region-string">SipiImage.crop(&lt;iiif-region-string&gt;)<a class="headerlink" href="#sipiimagecropiiif-region-string" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>success, errormsg = img.crop(&lt;IIIF-region-string&gt;)
</code></pre></div>
<p>Crops the image to the given rectangular region. The parameter must be a
valid IIIF-region string.</p>
<h3 id="sipiimagescaleiiif-size-string">SipiImage.scale(&lt;iiif-size-string&gt;)<a class="headerlink" href="#sipiimagescaleiiif-size-string" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>success, errormsg = img.scale(&lt;iiif-size-string&gt;)
</code></pre></div>
<p>Resizes the image to the given size as IIIF-conformant size string.</p>
<h3 id="sipiimagerotateiiif-rotation-string">SipiImage.rotate(&lt;iiif-rotation-string&gt;)<a class="headerlink" href="#sipiimagerotateiiif-rotation-string" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>success, errormsg = img.rotate(&lt;iiif-rotation-string&gt;)
</code></pre></div>
<p>Rotates and/or mirrors the image according the given iiif-conformant rotation string.</p>
<h3 id="sipiimagetopleft">SipiImage.topleft()<a class="headerlink" href="#sipiimagetopleft" title="Permanent link">&para;</a></h3>
<p>Rotates an image to the standard TOPLEFT orientation if necessary. Please note
that viewers using tiling (e.g. <a href="https://openseadragon.github.io">openseadragon</a>) require images in TOPLEFT rotation.
Thus, it is highly recommended that all images served by SIPI IIIF will be set to TOPLEFT orientation. This process may
involve rotation of 90, 180 or 270 degrees and possible mirroring which does <em>not</em> change the pixel values through interpolation.</p>
<h3 id="sipiimagewatermarkwm-file-path">SipiImage.watermark(wm-file-path)<a class="headerlink" href="#sipiimagewatermarkwm-file-path" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>success, errormsg = img.watermark(wm-file-path)
</code></pre></div>
<p>Applies the given watermark file to the image. The watermark file must
be a single channel 8-Bit gray value TIFF file.</p>
<h3 id="sipiimagewritefilepath-compression_params">SipiImage.write(filepath, [compression_params])<a class="headerlink" href="#sipiimagewritefilepath-compression_params" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>success, errormsg = img.write(filepath)
success, errormsg = img.write(&#39;HTTP.jpg&#39;)
</code></pre></div>
<p>The first version write the image to a file in the SIPI server, the second writes the file
to the HTTP connection (which is done whenever the basename of the output file is <code>HTTP</code>):</p>
<p>Parameters:</p>
<ul>
<li>
<p><code>filepath</code>: Path to output file. The file format is determined by the filename extension. Supported are</p>
<ul>
<li><code>jpg</code> : writes a JPEG file</li>
<li><code>tif</code> : writes a TIFF file</li>
<li><code>png</code> : writes a PNG file</li>
<li><code>jpx</code> : writes a JPEG2000 file</li>
<li><code>webp</code> : writes a WebP file</li>
<li><code>gif</code> : writes a GIF file</li>
<li><code>pdf</code> : writes a PDF file</li>
</ul>
</li>
<li>
<p><code>compression_params</code>: (optional) An optional Lua table with compression parameters (which are dependent on the
  chosen output file format!) can be given. All compression parameters are optional. But if a compression parameter
  table is give, it must have at least one entry.</p>
</li>
<li>JPEG format:<ul>
<li><code>quality</code>: Number between 1 and 100 (1 highest compression, worst quality, 100 lowest compression, best quality)      </li>
</ul>
</li>
<li>JPEG2000 format:<ul>
<li><code>Sprofile</code>: Any of <code>PROFILE0</code>, <code>PROFILE1</code>, <code>PROFILE2</code>, <code>PART2</code>, <code>CINEMA2K</code>, <code>CINEMA4K</code>, <code>BROADCAST</code>,
  <code>CINEMA2S</code>, <code>CINEMA4S</code>, <code>CINEMASS</code>, <code>IMF</code>. Defaults to <code>PART2</code>.</li>
<li><code>Creversible</code>: Use the reversible compression algorithms of JPEG2000. Must be string <code>yes</code> or <code>no</code>. Defaults
      to <code>yes</code>.</li>
<li><code>Clayers</code>: Number of layers to use.</li>
<li><code>Clevels</code>: Number of levels to use.</li>
<li><code>Corder</code>: Ordering of file components. Must be one of the following strings: <code>LRCP</code>, <code>RLCP</code>, <code>RPCL</code>, <code>PCRL</code> or
  <code>CPRL</code>.</li>
<li><code>Cprecincts</code>: A kakadu conformant precinct string.</li>
<li><code>rates</code>: rates string as used in kakadu.</li>
</ul>
</li>
</ul>
<h3 id="sipiimagesendformat">SipiImage.send(format)<a class="headerlink" href="#sipiimagesendformat" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>success, errormsg = img.send(format)
</code></pre></div>
<p>Sends the file to the HTTP connection. Supported format strings:</p>
<ul>
<li><code>jpg</code> : sends a JPEG file</li>
<li><code>tif</code> : sends a TIFF file</li>
<li><code>png</code> : sends a PNG file</li>
<li><code>jpx</code> : sends a JPEG2000 file</li>
<li><code>webp</code> : sends a WebP file</li>
<li><code>gif</code> : sends a GIF file</li>
</ul>
<h3 id="sipiimagemimetype_consistencymimetype-filename">SipiImage.mimetype_consistency(mimetype, filename)<a class="headerlink" href="#sipiimagemimetype_consistencymimetype-filename" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="n">success</span><span class="p">,</span> <span class="n">consistent</span> <span class="o">=</span> <span class="n">img</span><span class="p">:</span><span class="n">mimetype_consistency</span><span class="p">(</span><span class="n">mimetype</span><span class="p">,</span> <span class="n">original_filename</span><span class="p">)</span>
</code></pre></div>
<p>This method checks if the supplied MIME type (e.g. received from the browser during upload), the file's
magic number (<a href="https://en.wikipedia.org/wiki/List_of_file_signatures">file signature</a>), and the file extension are
consistent.</p>
<p><strong>Parameters:</strong></p>
<ul>
<li><code>mimetype</code> (string): The expected MIME type (e.g., <code>"image/tiff"</code>).</li>
<li><code>original_filename</code> (string): The original filename with extension (e.g., <code>"photo.tif"</code>).</li>
</ul>
<p><strong>Returns:</strong> <code>(true, boolean)</code> on success where the boolean indicates consistency, or <code>(false, error_message)</code> on failure.</p>
<p>Please note that MIME type handling can be quite complex, since the correspondence between file extensions and
MIME types is not unambiguous. In addition the file signature cannot identify all MIME types. For example, a "comma
separated values" file (extension <code>.csv</code>) can have a MIME type of <code>application/csv</code>, <code>text/csv</code>, <code>text/x-csv</code>,
<code>application/vnd.ms-excel</code> and more. However, the file signature will usually return <code>text/plain</code>. SIPI tries to cope
with these ambiguities.</p>
<h3 id="example-image-processing-pipeline">Example: Image Processing Pipeline<a class="headerlink" href="#example-image-processing-pipeline" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1">-- Read an image, crop, scale, rotate, and write to a new format</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="n">img</span> <span class="o">=</span> <span class="n">SipiImage</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;input.tif&quot;</span><span class="p">)</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="n">img</span><span class="p">:</span><span class="n">crop</span><span class="p">(</span><span class="s2">&quot;100,100,500,500&quot;</span><span class="p">)</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="n">img</span><span class="p">:</span><span class="n">scale</span><span class="p">(</span><span class="s2">&quot;400,&quot;</span><span class="p">)</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="n">img</span><span class="p">:</span><span class="n">rotate</span><span class="p">(</span><span class="s2">&quot;90&quot;</span><span class="p">)</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="n">img</span><span class="p">:</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;output.jpx&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1">-- Process an uploaded file and send the result via HTTP</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="n">img</span> <span class="o">=</span> <span class="n">SipiImage</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1">-- first uploaded file</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="n">img</span><span class="p">:</span><span class="n">topleft</span><span class="p">()</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="n">img</span><span class="p">:</span><span class="n">scale</span><span class="p">(</span><span class="s2">&quot;!800,800&quot;</span><span class="p">)</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="n">img</span><span class="p">:</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;jpg&quot;</span><span class="p">)</span>
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      &copy; 2017 - 2026 <a href='https://dasch.swiss' target='_blank'>Data and Service Center for the Humanities (DaSCH)</a>
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["search.suggest", "search.highlight", "navigation.sections", "toc.integrate", "content.code.copy"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.1e8ae164.min.js"></script>
      
    
  </body>
</html>